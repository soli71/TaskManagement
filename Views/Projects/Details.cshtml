<form asp-action="Delete" method="post" class="mt-3" onsubmit="return confirm('آیا از حذف این پروژه مطمئن هستید؟ تمام تسک‌ها از این پروژه جدا می‌شوند.');">
    <input type="hidden" name="id" value="@Model.Id" />
    <corp-btn variant="outline" icon="bi-trash" type="submit" dense>حذف پروژه</corp-btn>
    <corp-btn variant="secondary" icon="bi-arrow-right" asp-action="Index" dense>بازگشت</corp-btn>
    <corp-btn variant="outline" icon="bi-pencil" asp-action="Edit" asp-route-id="@Model.Id" dense>ویرایش</corp-btn>
</form>
@model TaskManagementMvc.Models.Project

@{
    ViewData["Title"] = "جزئیات پروژه";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1 fw-bold text-primary">
                <i class="bi bi-folder-open text-warning me-2"></i>
                @Model.Name
            </h2>
            <p class="text-muted mb-0">کد پروژه: <span class="badge bg-secondary">@Model.Code</span></p>
        </div>
        <div class="d-flex gap-2">
            <corp-btn variant="primary" icon="bi-kanban" asp-controller="Tasks" asp-action="Board" asp-route-code="@Model.Code" dense>بورد تسک‌ها</corp-btn>
            @if (User.IsInRole("SystemAdmin") || User.IsInRole("SystemManager") || User.IsInRole("CompanyManager"))
            {
                <corp-btn variant="outline" icon="bi-shield-lock" asp-action="ManageAccess" asp-route-id="@Model.Id" dense>مدیریت دسترسی</corp-btn>
            }
            <corp-btn variant="outline" icon="bi-pencil" asp-action="Edit" asp-route-id="@Model.Id" dense>ویرایش</corp-btn>
            <corp-btn variant="danger" icon="bi-trash" type="button" onclick="deleteProject(@Model.Id, '@Model.Name')" dense>حذف</corp-btn>
        </div>
    </div>

    <div class="row">
        <!-- Main Project Information -->
        <div class="col-lg-8">
            <!-- Project Overview Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="bi bi-info-circle me-2"></i>
                    <h5 class="mb-0">اطلاعات کلی پروژه</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="info-label">نام پروژه</label>
                                <p class="info-value">@Model.Name</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="info-label">وضعیت</label>
                                <p class="info-value">
                                    <corp-badge variant="secondary" dense>
                                        @switch(Model.Status.ToString())
                                        {
                                            case "Planning": <text>در حال برنامه‌ریزی</text>; break;
                                            case "InProgress": <text>در حال اجرا</text>; break;
                                            case "OnHold": <text>متوقف شده</text>; break;
                                            case "Completed": <text>تکمیل شده</text>; break;
                                            case "Cancelled": <text>لغو شده</text>; break;
                                            default: <text>@Model.Status</text>; break;
                                        }
                                    </corp-badge>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="info-label">اولویت</label>
                                <p class="info-value">
                                    <corp-badge variant="secondary" dense>
                                        @switch(Model.Priority.ToString())
                                        {
                                            case "Low": <text><i class="bi bi-chevron-down"></i> کم</text>; break;
                                            case "Medium": <text><i class="bi bi-dash"></i> متوسط</text>; break;
                                            case "High": <text><i class="bi bi-chevron-up"></i> بالا</text>; break;
                                            case "Critical": <text><i class="bi bi-exclamation-triangle-fill"></i> بحرانی</text>; break;
                                            default: <text>@Model.Priority</text>; break;
                                        }
                                    </corp-badge>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="info-label">مدیر پروژه</label>
                                <p class="info-value">
                                    @if (Model.ProjectManager != null)
                                    {
                                        <i class="bi bi-person-check text-success me-1"></i>
                                        @Model.ProjectManager.FullName
                                    }
                                    else
                                    {
                                        <span class="text-muted">تعیین نشده</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(Model.Description))
                    {
                        <div class="mt-4">
                            <label class="info-label">توضیحات</label>
                            <div class="description-box">
                                @Model.Description
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Timeline Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-info text-white d-flex align-items-center">
                    <i class="bi bi-calendar-range me-2"></i>
                    <h5 class="mb-0">زمان‌بندی پروژه</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="timeline-item">
                                <i class="bi bi-calendar-event text-primary"></i>
                                <div class="timeline-content">
                                    <label class="timeline-label">تاریخ شروع</label>
                                    <p class="timeline-value">
                                        @(Model.StartDate?.ToPersianDate() ?? "تعیین نشده")
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="timeline-item">
                                <i class="bi bi-calendar-check text-warning"></i>
                                <div class="timeline-content">
                                    <label class="timeline-label">پایان تخمینی</label>
                                    <p class="timeline-value">
                                        @(Model.EstimatedEndDate?.ToPersianDate() ?? "تعیین نشده")
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="timeline-item">
                                <i class="bi bi-calendar-x text-success"></i>
                                <div class="timeline-content">
                                    <label class="timeline-label">پایان واقعی</label>
                                    <p class="timeline-value">
                                        @(Model.ActualEndDate?.ToPersianDate() ?? "تکمیل نشده")
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex align-items-center">
                    <i class="bi bi-cash-coin me-2"></i>
                    <h5 class="mb-0">اطلاعات مالی</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="budget-item">
                                <i class="bi bi-wallet text-primary fs-3"></i>
                                <div class="budget-content">
                                    <label class="budget-label">بودجه اولیه</label>
                                    <p class="budget-value text-primary">
                                        @(Model.Budget?.ToString("N0") ?? "0") تومان
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="budget-item">
                                <i class="bi bi-receipt text-warning fs-3"></i>
                                <div class="budget-content">
                                    <label class="budget-label">هزینه واقعی</label>
                                    <p class="budget-value text-warning">
                                        @(Model.ActualCost?.ToString("N0") ?? "0") تومان
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    @if (Model.Budget.HasValue && Model.Budget > 0)
                    {
                        var percentage = Model.ActualCost.HasValue ? (int)((Model.ActualCost.Value / Model.Budget.Value) * 100) : 0;
                        var progressClass = percentage <= 50 ? "bg-success" : percentage <= 80 ? "bg-warning" : "bg-danger";
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="small">درصد استفاده از بودجه</span>
                                <span class="small fw-bold">@percentage%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar @progressClass" style="width: @percentage%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Company Info Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-secondary text-white d-flex align-items-center">
                    <i class="bi bi-building me-2"></i>
                    <h5 class="mb-0">اطلاعات شرکت</h5>
                </div>
                <div class="card-body text-center">
                    <i class="bi bi-building text-primary fs-1 mb-3"></i>
                    <h5 class="mb-0">@Model.Company?.Name</h5>
                    <p class="text-muted">@Model.Company?.Address</p>
                </div>
            </div>

            <!-- Quick Stats Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-dark text-white d-flex align-items-center">
                    <i class="bi bi-graph-up me-2"></i>
                    <h5 class="mb-0">آمار سریع</h5>
                </div>
                <div class="card-body">
                    <div class="stat-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="stat-label">
                                <i class="bi bi-list-task text-primary me-2"></i>
                                تعداد تسک‌ها
                            </span>
                            <span class="stat-value badge bg-primary">@Model.Tasks.Count</span>
                        </div>
                    </div>
                    
                    <div class="stat-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="stat-label">
                                <i class="bi bi-receipt text-success me-2"></i>
                                تعداد فاکتورها
                            </span>
                            <span class="stat-value badge bg-success">@Model.Invoices.Count</span>
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="stat-label">
                                <i class="bi bi-calendar-plus text-info me-2"></i>
                                تاریخ ایجاد
                            </span>
                            <span class="stat-value small text-muted">@Model.CreatedAt.ToPersianDate()</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <corp-btn variant="outline" icon="bi-list-task" asp-controller="Tasks" asp-action="Index" asp-route-projectId="@Model.Id" dense>تسک‌ها</corp-btn>
                        <corp-btn variant="outline" icon="bi-receipt" asp-controller="Invoices" asp-action="Index" asp-route-projectId="@Model.Id" dense>فاکتورها</corp-btn>
                        <corp-btn variant="outline" icon="bi-shield-check" asp-action="Access" asp-route-id="@Model.Id" dense>دسترسی</corp-btn>
                        <hr>
                        <corp-btn variant="outline" icon="bi-arrow-left" asp-action="Index" dense>بازگشت</corp-btn>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تأیید حذف پروژه</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">آیا از حذف پروژه مطمئن هستید؟</h5>
                    <p class="text-muted mb-0">پروژه <strong id="projectNameToDelete"></strong> حذف خواهد شد.</p>
                    <p class="text-danger small">توجه: تمام تسک‌های این پروژه از آن جدا خواهند شد.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <form id="deleteForm" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>حذف پروژه
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Delete project function
        function deleteProject(projectId, projectName) {
            document.getElementById('projectNameToDelete').textContent = projectName;
            document.getElementById('deleteForm').action = '@Url.Action("Delete")/' + projectId;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // Animation on load
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.4s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
}

@section Styles {
    <style>
        .card {
            transition: all 0.3s ease;
            border-radius: 12px;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        }
        
        .info-item {
            padding: 1rem;
            background: rgba(248, 249, 250, 0.6);
            border-radius: 8px;
            border-right: 4px solid #0d6efd;
        }
        
        .info-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: 500;
            color: #212529;
            margin: 0;
        }
        
        .description-box {
            background: rgba(248, 249, 250, 0.8);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            line-height: 1.6;
        }
        
        .timeline-item {
            display: flex;
            align-items-center;
            padding: 0.75rem;
            background: rgba(248, 249, 250, 0.6);
            border-radius: 8px;
        }
        
        .timeline-item i {
            font-size: 1.5rem;
            margin-left: 0.75rem;
        }
        
        .timeline-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .timeline-value {
            font-weight: 500;
            margin: 0;
        }
        
        .budget-item {
            display: flex;
            align-items-center;
            padding: 1rem;
            background: rgba(248, 249, 250, 0.6);
            border-radius: 8px;
        }
        
        .budget-content {
            margin-right: 1rem;
        }
        
        .budget-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .budget-value {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }
        
        .stat-item {
            padding: 0.5rem 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #495057;
        }
        
        .stat-value {
            font-size: 0.9rem;
        }
        
        .status-badge, .priority-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
        }
        
        .status-planning { background: linear-gradient(45deg, #17a2b8, #20c997); }
        .status-inprogress { background: linear-gradient(45deg, #007bff, #6610f2); }
        .status-onhold { background: linear-gradient(45deg, #ffc107, #fd7e14); }
        .status-completed { background: linear-gradient(45deg, #28a745, #20c997); }
        .status-cancelled { background: linear-gradient(45deg, #dc3545, #e83e8c); }
        
        .priority-low { background: linear-gradient(45deg, #6c757d, #adb5bd); }
        .priority-medium { background: linear-gradient(45deg, #007bff, #17a2b8); }
        .priority-high { background: linear-gradient(45deg, #fd7e14, #ffc107); }
        .priority-critical { background: linear-gradient(45deg, #dc3545, #e83e8c); }
        
        .card-header {
            border-radius: 12px 12px 0 0 !important;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
    </style>
}
