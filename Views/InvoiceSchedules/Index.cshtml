@model List<TaskManagementMvc.Models.InvoiceSchedule>
@{
    ViewData["Title"] = "زمان‌بندی‌های فاکتور";
    var runs = ViewBag.RecentRuns as List<TaskManagementMvc.Models.InvoiceJobRunLog> ?? new();
}
<div class="container" dir="rtl">
    <h2 class="mb-3">زمان‌بندی‌های صدور خودکار فاکتور</h2>
    <div class="mb-3">
        <a asp-action="Create" class="btn btn-success btn-sm">ایجاد زمان‌بندی جدید</a>
    </div>
    <table class="table table-bordered table-sm align-middle">
        <thead class="table-light">
            <tr>
                <th>نام</th>
                <th>شرکت</th>
                <th>تناوب</th>
                <th>ساعت</th>
                <th>گیرندگان</th>
                <th>فعال</th>
                <th>اجرای بعدی (محلی)</th>
                <th>اقدامات</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var s in Model)
        {
            <tr class="@(s.IsActive ? "" : "table-secondary")">
                <td><a asp-action="Details" asp-route-id="@s.Id">@s.Name</a></td>
                <td>@s.Company?.Name</td>
                <td>
                    @switch (s.PeriodType)
                    {
                        case TaskManagementMvc.Models.InvoiceSchedulePeriodType.Daily:
                            @:روزانه
                            break;
                        case TaskManagementMvc.Models.InvoiceSchedulePeriodType.Weekly:
                            @:(هفتگی - @s.DayOfWeek)
                            break;
                        case TaskManagementMvc.Models.InvoiceSchedulePeriodType.Monthly:
                            @:(ماهانه - روز @s.DayOfMonth)
                            break;
                    }
                </td>
                <td>@s.HourOfDay:00</td>
                <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="@s.RecipientEmails">@s.RecipientEmails</td>
                <td>@(s.IsActive ? "✔" : "✖")</td>
                <td>@(s.NextRunAt?.ToLocalTime().ToString("yyyy/MM/dd HH:mm"))</td>
                <td>
                    <form asp-action="ToggleActive" asp-route-id="@s.Id" method="post" class="d-inline">@Html.AntiForgeryToken()<button class="btn btn-sm @(s.IsActive?"btn-warning":"btn-success")" title="فعال/غیرفعال">@(s.IsActive?"غیرفعال":"فعال")</button></form>
                    <a asp-action="Edit" asp-route-id="@s.Id" class="btn btn-sm btn-primary">ویرایش</a>
                    <form asp-action="Trigger" asp-route-id="@s.Id" method="post" class="d-inline" onsubmit="return confirm('اجرا شود؟');">@Html.AntiForgeryToken()<button class="btn btn-sm btn-secondary">اجرا</button></form>
                </td>
            </tr>
        }
        </tbody>
    </table>

    <h4 class="mt-5">آخرین اجراها</h4>
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>زمان شروع</th>
                <th>زمان پایان</th>
                <th>زمان‌بندی</th>
                <th>تعداد تسک</th>
                <th>فاکتور</th>
                <th>وضعیت</th>
                <th>خطا</th>
            </tr>
        </thead>
        <tbody>
        @foreach(var r in runs)
        {
            <tr class="@(r.IsSuccess ? "" : "table-danger")">
                <td>@r.RunStartedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm:ss")</td>
                <td>@r.RunCompletedAt?.ToLocalTime().ToString("HH:mm:ss")</td>
                <td><a asp-action="Details" asp-route-id="@r.ScheduleId">@r.Schedule?.Name</a></td>
                <td>@r.TasksCount</td>
                <td>@if(r.InvoiceId!=null){<a asp-controller="Invoices" asp-action="Details" asp-route-id="@r.InvoiceId">@r.InvoiceId</a>}</td>
                <td>@(r.IsSuccess?"موفق":"ناموفق")</td>
                <td style="max-width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="@r.Error">@r.Error</td>
            </tr>
        }
        </tbody>
    </table>
</div>
