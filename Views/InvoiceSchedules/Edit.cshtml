@model TaskManagementMvc.Models.InvoiceSchedule
@{
    ViewData["Title"] = "ویرایش زمان‌بندی";
    var companies = ViewBag.Companies as List<TaskManagementMvc.Models.Company> ?? new();
}
<div class="container" dir="rtl">
    <h2>ویرایش زمان‌بندی</h2>
    <form asp-action="Edit" method="post" class="mt-3">@Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <div class="row g-3">
            <div class="col-md-4">
                <label asp-for="Name" class="form-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <label asp-for="CompanyId" class="form-label">شرکت</label>
                <select asp-for="CompanyId" class="form-select">
                    <option value="">--انتخاب--</option>
                    @foreach(var c in companies){<option value="@c.Id" selected="@(Model.CompanyId==c.Id)">@c.Name</option>}
                </select>
            </div>
            <div class="col-md-4">
                <label asp-for="PeriodType" class="form-label">تناوب</label>
                <select asp-for="PeriodType" class="form-select" id="periodType">
                    <option value="1" selected="@(Model.PeriodType==TaskManagementMvc.Models.InvoiceSchedulePeriodType.Daily)">روزانه</option>
                    <option value="2" selected="@(Model.PeriodType==TaskManagementMvc.Models.InvoiceSchedulePeriodType.Weekly)">هفتگی</option>
                    <option value="3" selected="@(Model.PeriodType==TaskManagementMvc.Models.InvoiceSchedulePeriodType.Monthly)">ماهانه</option>
                </select>
            </div>
            <div class="col-md-4 weekly-field d-none">
                <label asp-for="DayOfWeek" class="form-label">روز هفته</label>
                <select asp-for="DayOfWeek" class="form-select">
                    <option value="">--انتخاب--</option>
                    @foreach(var dow in Enum.GetValues<DayOfWeek>()) {<option value="@dow" selected="@(Model.DayOfWeek==dow)">@dow</option>}
                </select>
                <span asp-validation-for="DayOfWeek" class="text-danger"></span>
            </div>
            <div class="col-md-4 monthly-field d-none">
                <label asp-for="DayOfMonth" class="form-label">روز ماه</label>
                <input asp-for="DayOfMonth" class="form-control" type="number" min="1" max="31" />
                <span asp-validation-for="DayOfMonth" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <label asp-for="HourOfDay" class="form-label">ساعت اجرا (0-23)</label>
                <input asp-for="HourOfDay" class="form-control" type="number" min="0" max="23" />
                <span asp-validation-for="HourOfDay" class="text-danger"></span>
            </div>
            <div class="col-md-6">
                <label asp-for="RecipientEmails" class="form-label">ایمیل‌های گیرنده</label>
                <textarea asp-for="RecipientEmails" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-md-6">
                <label asp-for="Description" class="form-label">توضیحات</label>
                <textarea asp-for="Description" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-md-4 form-check mt-2">
                <input asp-for="IsActive" class="form-check-input" />
                <label asp-for="IsActive" class="form-check-label">فعال</label>
            </div>
            <div class="col-md-4 form-check mt-2">
                <input type="checkbox" name="recomputeNext" class="form-check-input" id="recomputeNext" />
                <label class="form-check-label" for="recomputeNext">محاسبه مجدد اجرای بعدی</label>
            </div>
            <div class="col-md-4">
                <label class="form-label">اجرای بعدی فعلی</label>
                <input type="text" readonly class="form-control" value="@Model.NextRunAt?.ToLocalTime().ToString("yyyy/MM/dd HH:mm")" />
            </div>
        </div>
        <div class="mt-4">
            <button class="btn btn-primary">ذخیره</button>
            <a asp-action="Index" class="btn btn-secondary">بازگشت</a>
        </div>
    </form>
</div>
@section Scripts {
<script>
function toggleFields(){
  const pt = document.getElementById('periodType').value;
  document.querySelector('.weekly-field').classList.toggle('d-none', pt !== '2');
  document.querySelector('.monthly-field').classList.toggle('d-none', pt !== '3');
}
setTimeout(toggleFields,0);
document.getElementById('periodType').addEventListener('change', toggleFields);
</script>
}
